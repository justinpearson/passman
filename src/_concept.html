<html>

<head>
  <style>
    #account, #field {
      width: 10em;
    }

    .good {
      outline: 1px solid lightgreen;
    }
    .bad {
      outline: 1px solid red;
    }

    th,td {
      border: 1px solid black;
    }
    #view-holder table {
      border-collapse: collapse;
    }
  </style>

  <script>
    function copyToClipboard(text) {
      var originalFocusElement = document.activeElement;
      // adapted from: https://stackoverflow.com/a/30810322
      var textArea = document.createElement("textarea");

      //
      // *** This styling is an extra step which is likely not required. ***
      //
      // Why is it here? To ensure:
      // 1. the element is able to have focus and selection.
      // 2. if element was to flash render it has minimal visual impact.
      // 3. less flakyness with selection and copying which **might** occur if
      //    the textarea element is not visible.
      //
      // The likelihood is the element won't even render, not even a flash,
      // so some of these are just precautions. However in IE the element
      // is visible whilst the popup box asking the user for permission for
      // the web page to copy to the clipboard.
      //

      // Place in top-left corner of screen regardless of scroll position.
      textArea.style.position = 'fixed';
      textArea.style.top = 0;
      textArea.style.left = 0;

      // Ensure it has a small width and height. Setting to 1px / 1em
      // doesn't work as this gives a negative w/h on some browsers.
      textArea.style.width = '2em';
      textArea.style.height = '2em';

      // We don't need padding, reducing the size if it does flash render.
      textArea.style.padding = 0;

      // Clean up any borders.
      textArea.style.border = 'none';
      textArea.style.outline = 'none';
      textArea.style.boxShadow = 'none';

      // Avoid flash of white box if rendered for any reason.
      textArea.style.background = 'transparent';


      textArea.value = text;

      document.body.appendChild(textArea);

      textArea.select();

      document.execCommand('copy');

      document.body.removeChild(textArea);

      originalFocusElement.focus();
    }

    class SecretsView {
      constructor(element, getData, getAccountQ, getFieldQ) {
        this.element = element;
        this.getData = getData;
        this.getAccountQ = getAccountQ;
        this.getFieldQ = getFieldQ;
      }

      static filterJ(j, q1, q2) {
        if (j === null) return [];
        var result = {};
        query(q1, j).forEach(k => {
          result[k] = {}
          query(q2, j[k]).forEach(k2 => {
            result[k][k2] = window.j[k][k2];
          });
        });
        return result;
      }

      refresh() {
        this.element.innerHTML = '';
        var j = SecretsView.filterJ(this.getData(), this.getAccountQ(), this.getFieldQ());
        if (j === null || Object.keys(j).length === 0) return;

        var tbody = appendNewChild($('#view-holder'), `
          <table>
            <tr>
              <th>Account</th>
              <th>Copy</th>
            </tr>
          </table>`).getElementsByTagName('tbody')[0];
        Object.entries(j).forEach(([account, info]) => {
          var tr = appendNewChild(tbody, '<tr />');
          appendNewChild(tr, '<td />').innerText = account;
          var dataCell = appendNewChild(tr, '<td />');
          Object.entries(info).sort().forEach(([name, field]) => {
            var copyButton = appendNewChild(dataCell, `<button class="copy-button">${escape(name)}</button>`);
            copyButton.addEventListener('click', () => {copyToClipboard(field); flashText(copyButton, 'Copied!')});
            appendNewChild(dataCell, '<br />');
          });
        });
      }
    }


    function query(q, obj) {
      var regexp = new RegExp('^' + q.replace(/ /g, '.+'))
      return Object.keys(obj).sort().filter(s => regexp.test(s));
    }

    function only(xs) {
      if (xs.length !== 1) {
        throw `expected 1 thing, got ${xs.length}: ${JSON.stringify(xs)}`
      }
      return xs[0];
    }

    function makeGood(e) {
      e.classList.add('good');
      e.classList.remove('bad');
    }
    function makeBad(e) {
      e.classList.add('bad');
      e.classList.remove('good');
    }
    function doAndSetGoodness(e, f) {
      var result;
      try {
        result = f();
        makeGood(e);
      } catch (err) {
        makeBad(e);
        e.focus();
        throw err;
      }
      return result;
    }

    function copySpecified() {
      var accountQuery = $('#account').value;
      var fieldQuery = $('#field').value;
      var info = doAndSetGoodness($('#account'), () => window.j[only(query(accountQuery, window.j))]);
      var val  = doAndSetGoodness($('#field'),   () => info[only(query(fieldQuery, info))]);
      copyToClipboard(val);
      flashText($('#copy-button'), 'Copied!');
    }

    function appendNewChild(parent, html) {
      var result = parseHTML(html, parent.tagName);
      parent.appendChild(result);
      return result;
    }

    var view;
    window.addEventListener('load', () => {
      view = new SecretsView(
        $('#view-holder'),
        () => window.j,
        () => $('#account').value,
        () => $('#field').value,
      );
    });

    function updateView() {
      view.refresh();
      $('#decrypt-button').disabled = isDecrypted();
      [$('#encrypt-button'), $('#copy-plaintext-button'), $('#encrypt-and-download-button')].forEach(button => {
        button.disabled = !isDecrypted();
      });
    }

    window.j = null;
    function isDecrypted() {
      return window.j !== null;
    }
    function isQueryPrecise() {
      if (!isDecrypted()) return false;
      var accountQuery = $('#account').value;
      var accountMatches = query(accountQuery, window.j);
      if (accountMatches.length !== 1) {
        return false;
      }
      var fieldQuery = $('#field').value;
      var fieldMatches = query(fieldQuery, window.j[accountMatches[0]]);
      return fieldMatches.length === 1;
    }

    var encryptedJ = {
      "github": {
        "username": "leethacker",
        "password": "pw-for-github"
      },
      "amazon": {
        "username": "potato.king@gmail.com",
        "password": "pw-for-amazon",
        "email": "potato.king@gmail.com"
      },
      "google": {
        "username": "potato.king",
        "password": "pw-for-google"
      },
      "google__throwaway": {
        "username": "throwaway2349",
        "password": "pw-for-google"
      },
      "google__throwaway2": {
        "username": "yet.another.alias",
        "password": "pw-for-google"
      },
      "facebook": {
        "username": "yet.another.alias@gmail.com",
        "password": "pw-for-facebook",
        "email": "yet.another.alias@gmail.com"
      },
      "pypi.python.org:potato.king@gmail.com": {
        "username": "potato.king@gmail.com",
        "password": "pw-for-pypi.python.org:potato.king@gmail.com",
        "email": "potato.king@gmail.com"
      },
      "verizon": {
        "username": "throwaway2349@gmail.com",
        "password": "pw-for-verizon",
        "email": "throwaway2349@gmail.com"
      },
      "lesserwrong": {
        "username": "Optimal Alias",
        "password": "pw-for-lesserwrong"
      }
    }

    function unlock() {
      doAndSetGoodness($('#password'), () => {
        if ($('#password').value !== 'foo') throw 'wrong password';
        window.j = encryptedJ;
        updateView();
      });
      $('#account').focus()
    }
    function copyPlaintext() {
      copyToClipboard(JSON.stringify(window.j, null, 2));
      flashText($('#copy-plaintext-button'), 'Copied!');
    }
    function download(filename, text) {
      // adapted from: https://stackoverflow.com/a/18197511/8877656
      var pom = document.createElement('a');
      pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
      pom.setAttribute('download', filename);

      if (document.createEvent) {
        var event = document.createEvent('MouseEvents');
        event.initEvent('click', true, true);
        pom.dispatchEvent(event);
      }
      else {
        pom.click();
      }
    }
    function lockAndDownload() {
      lock();
      alert('downloading a new page is not yet implemented');
      throw 'downloading a new page is not yet implemented';
      download('passman.html', something);
    }
    function lock() {
      encryptedJ = JSON.parse(JSON.stringify(window.j)); // kludgey deep copy

      // Probably a dumb threat model, but:
      // modify objects in-place as much as possible so they're not just
      // floating around easily inspectable until the GC runs.
      Object.entries(window.j).forEach(([account, info]) => {
        Object.keys(info).forEach(k => {delete info[k]});
        delete window.j[account];
      });
      window.j = null;
      Array.from(document.getElementsByTagName('input'))
              .filter(e => e.type==='password')
              .forEach(e => {e.value = ''});
      makeBad($('#password'));
      $('#password').focus()
      updateView();
    }

    function flashText(e, t) {
      var originalText = e.innerText;
      e.innerText = t;
      setTimeout(() => {e.innerText = originalText}, 500);
    }

    function $(s) {return document.getElementById(s.slice(1));}

    function parseHTML(html, parentTagName='div') {
      var e = document.createElement(parentTagName);
      e.innerHTML = html.trim();
      if (e.childNodes[0]===undefined) debugger
      return e.childNodes[0];
    }
    function ask(prompt, isSensitive=true) {
      var modal = parseHTML('<div class="modal" />');
      document.body.appendChild(modal);
      var modalContent = parseHTML('<div class="modal-content" />');
      modal.appendChild(modalContent);
      modalContent.innerText = prompt

      var input = document.createElement('input');
      modalContent.appendChild(input);
      if (isSensitive) input.type = 'password';
      input.focus();
      return new Promise((resolve, reject) => {
        onEnter(input, () => {
          resolve(input.value);
          input.value = '';
          input.remove();
          modal.remove();
        });
      });
    }

    function onEnter(element, callback) {
      element.addEventListener('keypress', (event) => {
        if (event.keyCode === 13) {
          callback(event);
        }
      });
    }

    window.addEventListener('load', () => {
      $('#password').focus();
      onEnter($('#password'), unlock);
      onEnter($('#set-value'), () => {
        var account = $('#account').value;
        var field = $('#field').value;
        var value = $('#set-value').value;
        if (window.j[account]===undefined) window.j[account] = {};
        if (value === '') {
          delete window.j[account][field];
          if (Object.keys(window.j[account]).length === 0) {
            delete window.j[account];
          }
        } else {
          window.j[account][field] = $('#set-value').value;
        }
        updateView();
      })
      try {[$('#field'), $('#account')].forEach(el => {
        onEnter(el, () => document.getElementsByClassName('copy-button')[0].click());
      });} catch (err) {debugger};
      updateView();
    });

  </script>
</head>

<body>


<input type="password" id="password" placeholder="decryption password" />
<button id="decrypt-button" onclick="unlock()">Unlock</button>
<button id="encrypt-button" onclick="lock()">Lock</button>
<button id="copy-plaintext-button" onclick="copyPlaintext()">Copy Plaintext</button>
<button id="encrypt-and-download-button" onclick="encryptAndDownload()">Lock and Download</button>

<div>
  Take
  <input type="text" oninput="updateView()" id="account" placeholder="account" />
  .
  <input type="text" oninput="updateView()" id="field" placeholder="field" value="password" />
  and...

  <ul>
    <li>
      ...copy it (by hitting Enter in one of those text fields, or clicking a button below).<br />
      (Those text fields are regexps, except Space is replaced with "one or more characters.")
    </li>
    <li>
      ...change it, by typing the new value here and hitting Enter:
      <input type="password" id="set-value" placeholder="new value" />
      (leave empty to delete).<br />
      (In this case, the above fields are <i>not</i> regexps, they are exact.)
    </li>
  </ul>
</div>

Query matches:
<div id="view-holder"></div>

<br />
<hr />
<br />
<details open>
  <summary><strong>Help</strong></summary>

  <p>The big idea: you probably have many accounts, and many pieces of data (username, password, email, recovery codes) associated with each account. All of your secrets, then, can be stored as a two-level JSON object, like</p>

  <pre>
    {
      "github": {
        "username": "leethacker",
        "password": "pw-for-github"
      },
      "amazon": {
        "username": "potato.king@gmail.com",
        "password": "pw-for-amazon",
        "email": "potato.king@gmail.com"
      },
      "google": {
        "username": "potato.king",
        "password": "pw-for-google"
      },
      "google__throwaway": {
        "username": "throwaway2349",
        "password": "pw-for-google"
      },

      ...
    }
  </pre>

  <p>This object is stored, encrypted, in this web page.</p>

  <p>To decrypt it, enter your master password and click the "Decrypt" button.</p>
  <p>The thing you'll want to do A LOT, I assume, is copy one of your secret data to the clipboard. To do this, type regexps in the "account" and "field" fields, and hit Enter (or click the "Copy field" button). The "account" query is matched against all the account names <span style="color:gray">(e.g. "github" or "google__throwaway" in the above example) (a query is a regexp that must match an account name if the letters in the query appear in that order in the account name, starting with the first letter; so "g" matches "google" and "github"; "gh" matches only "github"; and "h" matches neither)</span>. If the match is unique, then the "field" query is matched against all the keys of the account's JSON object; if that match is unique also, the field's value will be copied to the clipboard.</p>

  <p style="color: gray">
    (Example: to get my username for Amazon using the above example, I'd use the field-query "u" and the account-query "a". To get my password for my throwaway Google account, I'd use the field-query "p" and the account-query "g_t". For my other Google account, I'd use the account-query "gpk" instead.)
  </p>

  <p>Other things you can do with the obvious buttons: copy the entire plaintext JSON file to your clipboard; download the plaintext JSON file; (try to) remove all potentially-disastrous information from the browser's memory; or update/delete data. (Accounts will be automatically removed when their last data is removed, i.e. their associated JSON object is empty.)</p>

  <p></p>
</details>

</body>
</html>
