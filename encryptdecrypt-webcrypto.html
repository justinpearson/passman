<html><head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

  <script type="text/javascript">
    "use strict";

    /* ========================================================
                ENCRYPTION / DECRYPTION
       ======================================================== */

    const Subtle = window.crypto.subtle;
    async function encrypt(password, plaintext) {
      // adapted from: https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/encrypt#Example
      var pwUtf8 = new TextEncoder().encode(password);
      var pwHash = await Subtle.digest('SHA-256', pwUtf8);

      var iv = window.crypto.getRandomValues(new Uint8Array(12));
      var alg = { name: 'AES-GCM', iv: iv };

      var key = await Subtle.importKey('raw', pwHash, alg, false, ['encrypt']);

      var ptUtf8 = new TextEncoder().encode(plaintext);

      return [iv, await Subtle.encrypt(alg, key, ptUtf8)];
    }
    async function decrypt(password, iv, ciphertext) {
      // adapted from: https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/decrypt#Example
      var pwUtf8 = new TextEncoder().encode(password);
      var pwHash = await Subtle.digest('SHA-256', pwUtf8);
      var alg = { name: 'AES-GCM', iv: iv };
      var key = await Subtle.importKey('raw', pwHash, alg, false, ['decrypt']);

      var ptUtf8 = await Subtle.decrypt(alg, key, ciphertext);

      return new TextDecoder().decode(ptUtf8);
    }


    /* ========================================================
                DOWNLOADING A MODIFIED VERSION OF THIS PAGE
       ======================================================== */

    function download(filename, text) {
      // source: https://stackoverflow.com/a/18197511/8877656
      var pom = document.createElement('a');
      pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
      pom.setAttribute('download', filename);

      if (document.createEvent) {
        var event = document.createEvent('MouseEvents');
        event.initEvent('click', true, true);
        pom.dispatchEvent(event);
      }
      else {
        pom.click();
      }
    }

    function downloadThisPageWithNewIVAndCiphertext(iv, ciphertext) {
      var $iv = document.getElementById('iv');
      var $ciphertext = document.getElementById('ciphertext');
      var $plaintext = document.getElementById('plaintext');
      var oldIV = $iv.innerText;
      var oldCiphertext = $ciphertext.innerText;
      var oldPlaintext = $plaintext.value;

      $iv.innerText = JSON.stringify(Array.from(iv));
      $ciphertext.innerText = JSON.stringify(Array.from(new Uint8Array(ciphertext)));
      $plaintext.innerText = ''; $plaintext.value = '';

      var html = document.getElementsByTagName('html')[0].outerHTML;

      download('encryptdecrypt.html', html);

      $iv.innerText = oldIV;
      $ciphertext.innerText = oldCiphertext;
      $plaintext.value = oldPlaintext;
    }

    async function tryDecrypt() {
      var iv         = new Uint8Array(JSON.parse(document.getElementById('iv').innerText));
      var ciphertext = new Uint8Array(JSON.parse(document.getElementById('ciphertext').innerText)).buffer;
      if (document.getElementById('plaintext').value !== '') {
        alert('refusing to overwrite text present in plaintext area; delete it if you really want to')
        return
      }
      var pw = document.getElementById('password').value
      try {
        var plaintext = await decrypt(pw, iv, ciphertext);
        document.getElementById('plaintext').value = plaintext;
        document.getElementById('password').style['outline'] = '2px solid lightgreen';
      } catch (reason) {
        document.getElementById('password').style['outline'] = '2px solid red';
      }
    }

    async function onEncryptAndDownloadButtonClick() {
      var pw = document.getElementById('password').value;
      var plaintext = document.getElementById('plaintext').value;
      var iv_ciphertext = await encrypt(pw, plaintext)
      var iv = iv_ciphertext[0];
      var ciphertext = iv_ciphertext[1];

      try {
        var decrypted = await decrypt(pw, iv, ciphertext)
        if (decrypted === plaintext) {
          downloadThisPageWithNewIVAndCiphertext(iv, ciphertext);
        } else {
          alert('decrypt(encrypt(message)) was not identical! What the heck?');
        }
      } catch (reason) {
        alert("decryption failed: " + reason);
      };
    }
  </script>

</head>
<body>
<div hidden="" id="iv">[230,135,228,94,16,56,35,134,25,183,22,249]</div>
<div hidden="" id="ciphertext">[191,228,27,132,226,238,99,187,138,224,227,112,153,200,120,75,47,28,28,54,65,93,52,56,29,138,117,36,253,242,207,92,138,168,65,193,70,178,73,47,199,178,108,224,88,82,140,82,132,159,101,9,165,223,136,245,240,204,191,242,92,29,131,44,165,198,19,173,151,25,219,34,154,236,50,250,220,88,155,25,112,127,100,111,179,239,30,88,193,164,254,62,158,200,237,85,153,49,253,130,91,36,174,13,11,109,74,151,111,57,145,247,173,53,73,215,35,24,42,43,35,201,79,192,193,5,66,125,96,230,120,199,125,175,83,208,193,212,65,240,110,67,100,208,167,186,21,255,74,222,10,12,35,240,97,37,232,248,63,151,144,245,124,66,151,118,173,66,49,107,8,75,156,161,106,111,240,28,53,90,163,244,181,46,149,91,14,209,161,209,239,128,230,219,133,11,254,225,36,9,200,156,243,45,4,36,142,183,161,197,42,13,57,153,74,198,190,78,118,222,5,70,124,181,57,178,201,135,238,135,101,237,222,69,58,207,18,194,130,160,50,31,110,35,218,9,230,135,172,92,70,42,203,135,148,231,42,180,37,217,107,25,243,189,109,23,37,198,207,45,97,120,105,44,215,175,10,155,55,119,129,83,8,30,162,75,76,195,163,252,5,31,154,166,52,191,11,99,252,41,209,59,22,203,216,179,230,70,86,27,230,13,206,144,148,146,185,85,133,228,126,19,202,145,132,209,127,166,224,119,239,24,112,240,81,237,181,106,208,146,101,77,41,251,5,231,49,159,76,201,216,147,157,219,90,147,130,74,190,55,218,152,27,161,91,36,223,122,80,40,32,130,49,50,90,87,92,128,244,114,125,172,76,159,31,48,120,5,196,252,175,162,240,143,113,109,11,212,5,144,127,200,221,99,170,2,233,193,226,41,167,207,109,56,219,172,131,47,192,166,56,129,239,208,30,91,65,231,28,86,233,233,77,118,181,208,217,30,78,99,184,144,252,243,131,1,165,210,176,84,17,12,11,120,74,31,40,77,45,80,156,59,98,66,183,220,106,179,107,189,175,165,46,118,162,234,73,23,154,76,85,87,18,163,160,149,217,89,45,42,96,80,251,57,196,98,135,209,240,179,167,232,228,103,124,6,58,169,144,112,138,84,51,37,119,197,206,209,35,192,60,222,187,44,31,162,13,192,69,59,5,141,35,233,186,222,68,35,132,0,183,115,90,238,184,173,85,133,170,219,110,160,179,56,51,162,2,203,157,246,231,175,0,46,248,91,192,46,226,181,91,127,138,2,203,108,36,168,177,88,65,211,11,168,147,205,36,3,173,183,234,191,108,19,194,166,109,218,15,74,142,177,91,104,90,95,29,236,102,35,159,0,217,172,24,49,205,17,109,130,0,39,108,102,167,161,216,174,107,159,18,75,123,236,63,84,22,84,123,41,59,180,109,253,126,214,151,166,104,17,4,184,148,228,240,109,21,7,244,206,200,149,183,13,81,172,37,195,249,123,164,174,218,251,109,206,42,213,232,161,246,245,217,111,193,252,40,252,8,75,247,12,144,67,109,32,201,117,176,33,106,173,203,240,15,158,245,120,22,52,225,92,58,177,153,156,237,169,208,181,46,93,180,192,195,243,136,91,10,197,202,29,33,16,8,200,211,6,148,161,151,233,147,75,235,171,226,105,45,18,199,232,110,121,26,35,37,183,237,69,210,137,21,228,228,173,71,127,109,19,52,13,149,75,239,119,171,100,153,0,200,81,150,0,215,138,121,171,178,65,86,45,52,201,206,141,164,134,160,197,234,145,115,7,46,202,18,127,199,3,65,234,13,251,229,61,94,100,195,235,192,236,82,158,39,96,234,101,141,164,69,44,106,147,216,200,152,123,128,247,204,86,21,8,194,135,7,246,112,110,248,155,173,71,98,69,50,176,82,230,213,235,151,60,174,113,239,199,241,58,205,23,159,254,177,38,22,160,28,18,162,213,204,178,5,15,138,225,217,231,65,105,4,133,201,233,48,135,76,200,27,37,80,180,226,222,15,163,144,220,234,223,214,76,89,236,152,45,148,4,224,215,22,122,22,215,86,183,219,206,156,32,230,25,145,245,106,254,55,194,70,101,35,236,112,123,105,69,123,253,3,69,93,68,80,68,2,200,42,58,163,198,226,96,22,154,227,253,18,173,216,44,72,27,133,147,78,202,82,229,92]</div>

<input type="password" id="password" placeholder="password" oninput="if (document.getElementById('plaintext').value==='') tryDecrypt()">
<button onclick="tryDecrypt()">Decrypt</button>
<button onclick="onEncryptAndDownloadButtonClick()">Encrypt and Download</button>
<br>

<textarea id="plaintext" placeholder="plaintext" style="width:100%; height:20em"></textarea>




</body><div></div></html>
